#!/usr/bin/env ruby

require_relative '../lib/piwigo_client'

require 'optparse'
require 'progress_bar'

options = {
  'config' => '.piwigo.conf',
  'files' => []
}

parser = OptionParser.new do |opts|
  opts.banner = "Usage: #{$0} [options] (file... | @list)"

  opts.separator ''
  docstring = 'Set location of JSON configuration file (default: .piwigo.conf).'
  opts.on('--config FILE', docstring) { |o| options['config'] = o }
  opts.on('-h', '--help', 'Prints this help') do
    puts opts
    exit
  end

  opts.separator ''
  opts.separator 'Connection options (required):'
  opts.on('-b', '--base_uri HOSTNAME', 'Hostname of Piwigo server') do |o|
    options['base_uri'] = o
  end
  opts.on('-u', '--username USERNAME', 'Username') { |u| options['username'] = u }
  opts.on('-p', '--password PASSWORD', 'Password') { |p| options['password'] = p }

  opts.separator ''
  opts.separator 'Image options:'
  docstring = 'Piwigo category ID to upload files into (required)'
  opts.on('-c', '--category ID', Integer, docstring) { |o| options['category_id'] = o }

  opts.separator ''
  opts.separator 'Specifying files:'
  opts.separator '  List one or more files on the command line after the arguments.'
  opts.separator '  If a filename starts with @, it will be treated as a newline-separated list of files.'
end

parser.parse!

if File.exist?(options['config'])
  begin
    options = JSON.parse(File.read(options['config'])).merge(options)
  rescue JSON::ParserError
    puts "Error reading #{options['config']}; is it a JSON file?"
  end
elsif options['config'] != '.piwigo.conf'
  warn "Config file #{options['config']} not found; proceeding without it"
end

ARGV.each do |file|
  if file.start_with? '@'
    file_file = file[1..]
    options['files'] += File.readlines(file_file).map(&:chomp)
  else
    options['files'] << file
  end
end

%w[base_uri username password category_id].each do |key|
  unless key
    $stderr.puts "Error: You must set a value for #{key}"
    puts parser
    exit
  end
end

unless options['files'].any?
  $stderr.puts "Error: You must specify one or more files to upload."
  puts parser
  exit
end

total_data = options['files'].map { |f| File.stat(f).size }.sum

puts "Connecting to Piwigo at #{options['base_uri']} with username #{options['username']}"
client = PiwigoClient.new(base_uri: options['base_uri'], username: options['username'],
  password: options['password'])
client.login
client.check_session_status

pbar = ProgressBar.new(total_data, :bar, :percentage, :eta)
options['files'].each do |filename|
  pbar.puts "Uploading #{filename}"
  client.upload_file(filename, options['category_id'], pbar)
end

client.logout
